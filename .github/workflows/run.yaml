name: Run PDF Processor

on:
  # 手动触发工作流
  workflow_dispatch:
    inputs:
      zip_url:
        description: 'ZIP file URL'
        required: true
        default: 'https://example.com/path/to/your/files.zip'
      batch_size:
        description: 'Batch size for processing'
        required: false
        default: '2'
  
  # 或者根据你的需求添加自动触发
  push:
    branches: [ main ]
  # schedule:
  #   - cron: '0 0 * * *' # 每天运行

jobs:
  process-pdfs:
    runs-on: windows-latest # 或者 ubuntu-latest，根据你的程序需求
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: '8.0.x' # 根据你的 .NET 版本调整

    - name: Download ZIP file
      id: download
      run: |
        $zipUrl = "${{ github.event.inputs.zip_url }}"
        $outputPath = "$env:RUNNER_TEMP/files.zip"
        
        Write-Host "Downloading ZIP from: $zipUrl"
        
        # 使用 Invoke-WebRequest 下载文件
        Invoke-WebRequest -Uri $zipUrl -OutFile $outputPath -UseBasicParsing
        
        # 检查文件是否下载成功
        if (Test-Path $outputPath) {
          $fileSize = (Get-Item $outputPath).Length
          Write-Host "Downloaded ZIP file size: $fileSize bytes"
          echo "zip_path=$outputPath" >> $env:GITHUB_OUTPUT
        } else {
          Write-Error "Failed to download ZIP file"
          exit 1
        }
      shell: pwsh

    - name: Extract ZIP file
      run: |
        $zipPath = "${{ steps.download.outputs.zip_path }}"
        $extractPath = "$env:RUNNER_TEMP/extracted"
        
        Write-Host "Extracting ZIP to: $extractPath"
        
        # 创建提取目录
        New-Item -ItemType Directory -Force -Path $extractPath
        
        # 解压 ZIP 文件
        Expand-Archive -Path $zipPath -DestinationPath $extractPath -Force
        
        Write-Host "Extraction completed"
        Write-Host "Contents of extracted folder:"
        Get-ChildItem -Path $extractPath -Recurse | Select-Object -First 20
        
        # 输出提取路径供后续步骤使用
        echo "EXTRACT_PATH=$extractPath" >> $env:GITHUB_ENV

    - name: Build the project
      run: |
        dotnet restore
        dotnet build --configuration Release --no-restore

    - name: Run PDF Processor
      run: |
        $folderPath = "$env:EXTRACT_PATH"
        $batchSize = "${{ github.event.inputs.batch_size }}"
        
        # 构建项目并运行
        dotnet run --project WinPrint.csproj -- "$folderPath" "$batchSize"
        
        # 或者如果你需要编译后直接运行可执行文件
        # dotnet publish -c Release -o publish
        # ./publish/WinPrint.exe "$folderPath" "$batchSize"

    - name: Upload processed files as artifact (可选)
      if: always() # 即使失败也上传
      uses: actions/upload-artifact@v3
      with:
        name: processed-results
        path: |
          **/*.log
          **/*.txt
          **/*.json
        retention-days: 7