name: Run PDF Processor

on:
  workflow_dispatch:
    inputs:
      page_number:
        description: '要处理的页码（优先级最高，覆盖默认值）'
        required: false
        default: '2'
        type: string

jobs:
  process-pdfs:
    strategy:
      matrix:
        zip_url: [
          'https://github.com/xiaochuan-dev/pdf-static/releases/download/0.02/test1.zip',
          'https://github.com/xiaochuan-dev/pdf-static/releases/download/0.02/test2.zip',
          'https://github.com/xiaochuan-dev/pdf-static/releases/download/0.02/test3.zip',
          'https://github.com/xiaochuan-dev/pdf-static/releases/download/0.0.3/test4.zip'
        ]
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: '8.0.x'

    - name: Install 7-Zip
      run: |
        choco install 7zip -y
      shell: powershell

    - name: Download ZIP file
      id: download
      run: |
        $zipUrl = "${{ matrix.zip_url }}"
        $outputPath = "$env:RUNNER_TEMP/files.zip"
        
        Write-Host "Downloading ZIP from: $zipUrl"
        
        Invoke-WebRequest -Uri $zipUrl -OutFile $outputPath -UseBasicParsing
        
        if (Test-Path $outputPath) {
          $fileSize = (Get-Item $outputPath).Length
          Write-Host "Downloaded ZIP file size: $fileSize bytes"
          echo "zip_path=$outputPath" >> $env:GITHUB_OUTPUT
        } else {
          Write-Error "Failed to download ZIP file"
          exit 1
        }
      shell: pwsh

    - name: Extract ZIP file with 7-Zip
      run: |
        $zipPath = "${{ steps.download.outputs.zip_path }}"
        $extractPath = "$env:RUNNER_TEMP/extracted"
        
        Write-Host "Extracting ZIP to: $extractPath"
        
        # 清理目录
        if (Test-Path $extractPath) {
            Remove-Item -Path $extractPath -Recurse -Force
        }
        
        # 创建目录
        New-Item -ItemType Directory -Force -Path $extractPath
        
        # 使用7-Zip解压，指定编码
        7z x "$zipPath" -o"$extractPath" -aoa
        
        Write-Host "Extraction completed"
        
        echo "EXTRACT_PATH=$extractPath" >> $env:GITHUB_ENV
      shell: pwsh

    - name: Build the project
      run: |
        dotnet restore
        dotnet build --configuration Release --no-restore

    - name: Run PDF Processor
      id: run-processor
      run: |
        $folderPath = "$env:EXTRACT_PATH"
        
        # 确定页码参数
        # workflow_dispatch 触发且有输入时使用输入值，否则使用默认值 2
        if ("${{ github.event_name }}" -eq "workflow_dispatch" -and "${{ github.event.inputs.page_number }}" -ne 'null' -and "${{ github.event.inputs.page_number }}" -ne '') {
          $pageNumber = "${{ github.event.inputs.page_number }}"
          Write-Host "✓ 手动触发，使用输入的页码: $pageNumber"
        } else {
          $pageNumber = "2"
          Write-Host "✓ 自动触发或未输入，使用默认页码: $pageNumber"
        }
        
        # 验证页码是否为有效数字
        if (-not ($pageNumber -match '^\d+$')) {
          Write-Host "✗ 错误: 页码必须是正整数"
          exit 1
        }
        
        Write-Host "======================================="
        Write-Host "开始处理PDF..."
        Write-Host "文件夹路径: $folderPath"
        Write-Host "页码参数: $pageNumber"
        Write-Host "======================================="
        
        # 执行命令
        dotnet run --project win-print.csproj -- "$folderPath" $pageNumber
        
        # 检查执行结果
        if ($LASTEXITCODE -ne 0) {
          Write-Host "✗ PDF处理器执行失败，退出码: $LASTEXITCODE"
          exit $LASTEXITCODE
        }
      shell: pwsh

    - name: Upload processed extracted folder
      if: always()
      uses: actions/upload-artifact@v5
      with:
        name: processed-folder-${{ strategy.job-index }}
        path: ${{ env.EXTRACT_PATH }}/pdf_output
        retention-days: 7