name: Run PDF Processor

on:
  workflow_dispatch:
  push:

jobs:
  process-pdfs:
    strategy:
      matrix:
        zip_url: [
          'https://github.com/xiaochuan-dev/pdf-static/releases/download/0.0.1/test.zip'
        ]
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: '8.0.x'

    - name: Download ZIP file
      id: download
      run: |
        $zipUrl = "${{ matrix.zip_url }}"
        $outputPath = "$env:RUNNER_TEMP/files.zip"
        
        Write-Host "Downloading ZIP from: $zipUrl"
        
        Invoke-WebRequest -Uri $zipUrl -OutFile $outputPath -UseBasicParsing
        
        if (Test-Path $outputPath) {
          $fileSize = (Get-Item $outputPath).Length
          Write-Host "Downloaded ZIP file size: $fileSize bytes"
          echo "zip_path=$outputPath" >> $env:GITHUB_OUTPUT
        } else {
          Write-Error "Failed to download ZIP file"
          exit 1
        }
      shell: pwsh

    - name: Extract ZIP file
      run: |
        $zipPath = "${{ steps.download.outputs.zip_path }}"
        $extractPath = "$env:RUNNER_TEMP/extracted"
        Write-Host "Extracting ZIP to: $extractPath"
        
        New-Item -ItemType Directory -Force -Path $extractPath
        
        Add-Type -AssemblyName System.IO.Compression.FileSystem
        
        # 使用原始方法解压，先不解码文件名
        try {
            # 直接解压，不转换编码
            [System.IO.Compression.ZipFile]::ExtractToDirectory($zipPath, $extractPath)
            Write-Host "直接解压完成"
            
            # 然后重命名文件为正确的编码
            $gbk = [System.Text.Encoding]::GetEncoding("GBK")
            $utf8 = [System.Text.Encoding]::UTF8
            
            Get-ChildItem -Path $extractPath -Recurse | ForEach-Object {
                try {
                    # 原始文件名（乱码）
                    $rawName = $_.Name
                    
                    # 获取原始字节
                    $rawBytes = [System.Text.Encoding]::Default.GetBytes($rawName)
                    
                    # 假设原始是GBK，转换为UTF-8
                    $gbkBytes = $gbk.GetBytes($rawName)
                    $utf8Bytes = [System.Text.Encoding]::Convert($gbk, $utf8, $gbkBytes)
                    $newName = $utf8.GetString($utf8Bytes)
                    
                    if ($rawName -ne $newName) {
                        $newPath = Join-Path (Split-Path $_.FullName -Parent) $newName
                        Rename-Item -Path $_.FullName -NewName $newName -Force
                        Write-Host "重命名: $rawName -> $newName"
                    }
                }
                catch {
                    Write-Warning "重命名失败: $($_.Name), 错误: $_"
                }
            }
        }
        catch {
            Write-Host "直接解压失败，使用简单方法: $_"
            Expand-Archive -Path $zipPath -DestinationPath $extractPath -Force
        }
        
        echo "EXTRACT_PATH=$extractPath" >> $env:GITHUB_ENV
      shell: pwsh

    - name: Debug extracted files
      run: |
        $folderPath = "$env:EXTRACT_PATH"
        
        Write-Host "解压文件夹内容:"
        Get-ChildItem -Path $folderPath -Recurse | ForEach-Object {
            Write-Host "$($_.FullName)"
        }
      shell: pwsh

    - name: Build the project
      run: |
        dotnet restore
        dotnet build --configuration Release --no-restore

    - name: Run PDF Processor
      run: |
        $folderPath = "$env:EXTRACT_PATH"
        dotnet run --project win-print.csproj -- "$folderPath" "2"
      shell: pwsh

    - name: Upload processed extracted folder
      if: always()
      uses: actions/upload-artifact@v5
      with:
        name: processed-folder-${{ strategy.job-index }}
        path: ${{ env.EXTRACT_PATH }}
        retention-days: 7